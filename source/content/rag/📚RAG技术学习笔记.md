
#AI #RAG #学习笔记 #技术调研

> [!tip] 写在前面 最近在搞RAG相关的项目，发现这个领域变化太快了，从最初的简单向量检索到现在的各种花式玩法，记录一下学习过程，免得以后忘了 😅

## 📈 技术演进时间线

![[技术演进时间线.excalidraw.svg]]

> [!warning] 坑点提醒 网上很多文章把KAG放在Agentic RAG之前，这是错的！KAG是2024年9月才出的paper，Agentic RAG在24年上半年就火了

**个人理解：**

- **传统RAG**: 就是最基础的检索+生成，Meta 2020年提出的
- **Graph RAG**: 开始用知识图谱，能处理实体关系了
- **Agentic RAG**: 加了AI agent，能多步推理，会选择工具
- **KAG**: 蚂蚁开源的，主打逻辑推理，号称比RAG强很多

## 📝 文档解析的5种姿势

最近测试了各种分块方法，记录一下效果：

![[文档解析的5种姿势.excalidraw.svg]]

### 实测效果排行

|方法|我的体验|适合场景|成本|
|---|---|---|---|
|**语义分割**|🏆 效果确实最好，但要算相似度|质量要求高的项目|中等|
|**LLM分块**|🤖 最省心，但token烧钱|预算充足的时候|贵死了|
|**固定切分**|🔧 简单稳定，信息可能被切断|快速原型|最便宜|
|**结构切分**|📚 看文档质量，好的很好坏的很坏|规范化文档|便宜|
|**标点切分**|✂️ 中规中矩，长短不一|中文文档还行|便宜|

> [!note] 个人建议 项目初期用固定切分快速验证，有预算了上语义分割，钱多的直接LLM分块

## 🔍 检索这些年的进化

![[检索这些年的进化.excalidraw.svg]]
### 我踩过的坑（技术演进史）

**第一阶段：语义检索 + 数据宽表（已放弃）**

- ✅ 最开始觉得语义检索不费事且简单，embedding + 宽表查询
- ❌ 宽表维护要命，每次schema变更要重跑数据
- ❌ 向量存在PostgreSQL里，查询巨慢，几万条数据都卡
- 💀 **最终放弃**：维护成本太高，性能也不行

**第二阶段：PostgreSQL全文检索 + SQL预生成（部分放弃）**

- ✅ `tsvector + tsquery` 性能还行，中文分词勉强能用
- ✅ 专业术语自定义词典后效果好很多（待补充）
- ❌ SQL预生成逻辑越写越复杂
- ❌ 专业术语还是会被错误分词，"机器学习"拆成"机器"+"学习"
- 🔧 **保留但优化**：全文检索保留，但SQL预生成换成实体模板

**第三阶段：引入Milvus做语义检索（目前在用）**

- ✅ Milvus专门做向量，性能比PostgreSQL存向量好太多
- ✅ `collection.search()` API很简洁，topK查询很快
- ❌ 又多了一个组件，运维复杂度增加
- ❌ 数据同步是个问题，PostgreSQL和Milvus要保持一致
- 💡 现在用消息队列做数据同步，还算稳定

**第四阶段：PostgreSQL JSONB metadata检索（目前主力）**

- ✅ `metadata @> '{"department": "技术部"}'` 查询很灵活
- ✅ 不用JOIN了，所有相关信息都在metadata里
- ❌ 复杂嵌套查询容易出错，`metadata->'user'->'projects'[0]->>'name'` 这种
- ❌ GIN索引建不好，查询timeout是常事
- 🔧 现在是主要检索方式，配合全文和语义检索

**第五阶段：LLM意图识别 + Agentic Search（最新尝试）**

- ✅ 能根据查询内容智能选择检索策略
- ✅ 比硬编码的规则判断准确很多
- ❌ 每次查询多一次LLM调用，成本和延迟都增加
- ❌ 有时候判断不准，问技术问题选成了人员检索
- 💡 加了置信度和fallback，还在调优中

**缓存策略演进：**

- 🔴 **早期**：没有缓存，每次都查数据库和Milvus
- 🟡 **中期**：简单Redis缓存，但缓存失效策略有问题
- 🟢 **现在**：用content hash做key，embedding结果缓存1小时，metadata查询缓存30分钟

**目前的技术栈稳定性：**

- ✅ **PostgreSQL全文 + metadata**：成熟稳定，性能够用
- ✅ **Milvus语义检索**：专业向量库，比自己在PG里存向量靠谱
- ⚠️ **Agentic Search**：还在优化阶段，有时候不稳定
- ✅ **Redis缓存**：省钱神器，必不可少

具体改进点如下：
[[🏗️我的RAG系统重构笔记]]

## 🤖 Agent和RAG的记忆管理（重点！）

这是我最近思考比较多的问题，到底谁管什么：
### 我的理解

![[记忆管理边界.excalidraw.svg]]

想象你有两个助手在帮你聊天：
🧠 主Agent- 像个聪明的秘书

专门记住你们聊了什么
当你说"刚才那个公司"，它知道你指的是哪个，能感觉到你话题的变化，比如从聊工作突然转到聊吃的。

🔧 RAG Agent（技术专家）- 像个搜索专家

专门负责找资料
记住什么搜索方法好用，什么参数设置效果好，知道你喜欢什么样的答案格式

💾 共享存储（Context Store）- 像个小纸条

两个助手都把重要信息写在这里，确保他们不会信息不同步，就像微信群里大家都能看到的聊天记录。

具体流程：

你问问题
主Agent理解你的意思，更新对话状态
技术专家根据历史经验选择最佳搜索策略
两人通过小纸条保持信息同步，给你一个完美的回答

简单说就是：一个负责理解，一个负责搜索，中间有个地方让他们交换信息，这样既不会搞混，效率还很高！

**实际例子：**

```
用户：我想了解机器学习
AI：[介绍基础概念]
用户：那深度学习呢？
AI：[解释区别]  
用户：刚才你提到的神经网络...
```

这里"刚才你提到的"是语义问题，主Agent负责；但具体检索哪些文档，用什么参数，是RAG Agent的事。

## 💰 KAG - 最新的大杀器

> [!info] 什么是KAG 蚂蚁搞的Knowledge Augmented Generation，2024年9月开源，号称在专业领域吊打传统RAG
### KAG到底解决了什么问题？

**传统RAG的痛点（举例说明）：**

你问："苹果公司的CEO年薪多少？"

🤖 **传统RAG的思路：**

1. 把问题变成向量
2. 在文档库里找相似的句子
3. 可能找到："苹果很甜"、"苹果公司股价"这些不相关的

😅 **结果**：答非所问，或者给你一堆苹果水果的信息

🧠 **KAG的思路：**

1. 理解"苹果公司"是个实体，"CEO"是个职位，"年薪"是个属性
2. 在知识图谱里精确找：苹果公司 → CEO → Tim Cook → 年薪
3. 再结合文档里的具体数字

😎 **结果**：精确回答Tim Cook的年薪

### KAG核心创新

![[kag流程图.excalidraw.svg]]

### 实测数据（蚂蚁提供的）

|数据集|传统RAG|KAG|提升|
|---|---|---|---|
|HotpotQA|基准|+19.6%|🚀|
|2wiki|基准|+33.5%|🚀🚀|

**实际应用：**

- 电子政务：11,000份文档，精确率91.6%
- 医疗健康：疾病症状治疗查询

> [!warning] 但是... KAG还很新，生态不完善，学习成本高，别轻易上生产

## 🎯 技术选型指南（血泪经验）

### 什么时候选什么？
![[RAG选型建议.excalidraw.svg]]

### 个人建议（踩坑总结）

**如果你是：**

**🔰 新手/原型验证** → 传统RAG，LangChain + OpenAI + Pinecone，一天搞定

**🏢 企业项目** → Graph RAG 或 Agentic RAG，看具体需求

**🤖 Agent狂热者** → Agentic RAG，用pydantic AI/LangGraph/CrewAI

**🧠 算法专家** → 研究KAG，但别急着上生产

### 成本现实检查

| 技术          | 开发成本     | 运行成本     | 维护成本       | 适合预算 |
| ----------- | -------- | -------- | ---------- | ---- |
| 传统RAG       | 💰       | 💰       | 💰         | 紧张   |
| Graph RAG   | 💰💰     | 💰💰     | 💰💰💰💰💰 | 一般   |
| Agentic RAG | 💰💰💰   | 💰💰💰💰 | 💰💰💰     | 充足   |
| KAG         | 💰💰💰💰 | 💰💰💰   | 💰💰💰💰   | 很充足  |

## 🤔 个人思考和TODO

### 学到的教训

1. **不要追新技术追得太紧** - 传统RAG做好了就能解决80%的问题
2. **Agent虽然强大但很烧钱** - token消耗是传统RAG的3-5倍
3. **数据质量比技术更重要** - 垃圾进垃圾出，再高级的技术也救不了
4. **用户体验 > 技术炫技** - 500ms响应的传统RAG > 5s响应的Agent

### 接下来要深入的

- [ ] 在pgsql中试下分词，看看效果
- [ ] 研究agent和rag共同存储模块，利用content store
- [ ] 研究下多模态RAG（图片+文本）
- [ ] 看看GraphRAG在知识图谱构建上的最佳实践
- [ ] 优化现有的Agentic RAG成本

---

> [!quote] 总结 RAG这个领域变化太快，但核心思路还是那个：给LLM提供相关的外部知识。技术在变，问题在变，但解决问题的思路是不变的。选择适合自己项目的就行，别被新技术绑架了。

#技术选型 #RAG #实践经验
