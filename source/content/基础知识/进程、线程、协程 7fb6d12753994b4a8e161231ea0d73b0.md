# 进程、线程、协程

Owner: yancy yu

## 1. 进程、线程、协程基本含义

### 进程（Process）🏭

**定义：** 操作系统进行资源分配和调度的基本单位。每个进程有自己独立的内存空间。

**状态：** 创建、就绪、运行、阻塞、结束。

**通信：** 进程间通信方式包括**管道、信号、信号量（计数器）、共享内存、消息队列、socket**。

**内存空间：** 在许多现代操作系统中，一个进程的地址空间大小为4G，分为系统空间和用户空间两部分，其中用户空间独立，一般WINDOWS进程的用户空间为2G。

**生命周期👇**

- 父子进程的生命周期可以通过以下几个阶段来描述：
    1. **创建（Forking）**:
        - 当父进程调用`fork`系统调用时，操作系统会创建一个与父进程几乎完全相同的子进程。
        - 子进程从父进程继承了代码、变量、文件描述符等，但是拥有自己独立的内存空间。
        - 父进程和子进程会从`fork`调用的返回点继续执行，区别在于父进程的`fork`返回值是子进程的PID，子进程的返回值则是0。
    2. **执行（Execution）**:
        - 子进程可以继续执行与父进程相同的代码，也可以通过诸如`exec`系列系统调用来执行不同的程序。
        - 父进程和子进程互相独立地运行，它们的执行调度取决于操作系统的调度策略。
    3. **等待（Waiting）**:
        - 父进程可以选择等待子进程结束。这通常通过`wait`或`waitpid`等系统调用实现。
        - 等待可以使父进程在子进程完成后收集其退出状态，也可以确保子进程不会成为僵尸进程。
    4. **结束（Termination）**:
        - 子进程在完成其任务后会退出，通过`exit`系统调用来结束其生命周期，并将退出状态返回给父进程。
        - 如果父进程提前结束，子进程将由系统的init进程（PID为1的进程）接管，成为孤儿进程。
    5. **资源回收（Cleanup）**:
        - 当子进程结束后，内核会保留一些关于进程的信息以供父进程查询（例如退出状态）。父进程通过`wait`来读取这些信息，这一步称为“回收”子进程。
        - 如果父进程没有回收子进程，子进程将变成僵尸进程。如果父进程也结束了，子进程会被init进程接管并回收。
    
    这样，父子进程的生命周期就完成了一个完整的流程，从创建到结束，再到资源的回收和清理。
    

### 各种进程间通信方式的应用场景：

**1. 队列（Queue）和管道（Pipe）**

- **应用场景**：任务分发，生产者-消费者模型，数据流处理。
- **示例**：一个进程生成任务，其他进程负责执行任务。

**2. 共享内存（Shared Memory）**

- **应用场景**：高性能计算，图像处理，实时系统。
- **示例**：多个进程需要访问同一组数据进行计算。

**3. 套接字（Socket）**

- **应用场景**：跨机器或跨网络的通信，分布式系统。
- **示例**：聊天服务器，分布式数据库。

**4. 消息队列（Message Queue，如RabbitMQ、Kafka）**

- **应用场景**：大规模分布式系统，微服务架构，事件驱动系统。
- **示例**：电商网站的订单处理，日志收集。

**5. HTTP / RESTful API**

- **应用场景**：Web服务，跨平台和跨语言的通信。
- **示例**：移动应用与后端服务器的通信。

**6. RPC（远程过程调用）**

- **应用场景**：企业内部服务，微服务通信，低延迟需求。
- **示例**：内部服务调用，如用户认证服务。

**7. 文件**

- **应用场景**：批处理，数据导入/导出，配置共享。
- **示例**：日终报表生成，配置文件共享。

### 线程（Thread）🧵

**定义：** 进程的一个实体，CPU调度和分配资源的基本单位。线程可以共享同一个进程的资源。

**状态：** 新建、可运行、运行、阻塞、死亡。

**同步：** 线程同步是两个或多个共享资源的线程并发执行的协调。同步方式包括互斥量、信号量、事件。

**内存空间：** 所有线程共享该进程的地址空间，每个线程有各自独立的栈，堆被所有线程共享。

### 协程（Coroutine）⚙️

**定义：** 用户态线程，比线程更轻量级，不被操作系统内核管理。协程只有一个线程，上下文切换快，不存在线程不安全问题。

**适用场景：** 协程特别适合异步IO场景，从而提高服务的吞吐量。

## 2. 堆与栈的概念 🧠

### 堆（Heap）🌐

**定义：** 大家共有的空间，分全局堆和局部堆。全局堆是系统分配的空间，局部堆是用户分配的空间。

**注意：** 堆在操作系统对进程初始化时分配，运行过程中也可以向系统要额外的堆，但要记得归还给操作系统，避免内存泄漏。

### 栈（Stack）📚

**定义：** 每个线程独有的空间，用于保存运行状态和局部自动变量。每个C++对象的数据成员也存在于栈中，每个函数都有自己的栈。

**特点：** 每个线程的栈互相独立，因此栈是线程安全的。操作系统在切换线程时会自动切换栈。

## 3. 进程线程及堆栈关系的总结 📝

- 一个程序至少有一个进程，一个进程至少有一个线程。
- 线程的划分尺度小于进程，使得多线程程序并发性高。
- 进程在执行过程中拥有独立的内存单元，而多个线程共享内存，极大提高了程序运行效率。
- 进程和线程都是操作系统实现应用并发性的基本单元。
- 线程不能独立执行，必须依存于应用程序，由应用程序提供多个线程执行控制。
- 进程是具有一定独立功能的程序关于某个数据集合上的一次运行活动；线程是进程的一个实体，拥有一点必不可少的资源，可与同属一个进程的其他线程共享全部资源。