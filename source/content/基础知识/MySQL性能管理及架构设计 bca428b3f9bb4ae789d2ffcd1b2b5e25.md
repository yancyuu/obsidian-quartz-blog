# MySQL性能管理及架构设计

Owner: yancy yu
Tags: mysql

主服务器→从服务器*n

若无自动切换，切换大概需要30分钟

**监控指标**

1、并发量&&CPU使用率

并发量：同一时间处理的请求

一部分请 求是有连接数的500-700

- 风险：大量的并发： 数据库连接数被占满(max_connect 默认 100)超高的CPU使用率： 因CPU资源耗尽而出现宕机

2、64核 521G内存

Qps：每秒的查询数量35万次/s,

Tps:  每秒传输的事务处理个数 5万/s

- 风险：效率低下的sql（一个cpu一条）10ms 处理 1 sql1s 处理 100 sqlQPS< 100

3、磁盘IO：有峰值(由于数据库远程同步)

尽量不要在活动前对主服务器进行主从备份

- 主要瓶颈*风险： 磁盘IO性能突然下降 其他大量消耗磁盘的计划任务(做好磁盘维护)

**具体场景**

1、大表：（记录超过千万行 或者 表数据超过10G)

- 风险：DDl操作1.mysql<5.5建立索引锁表(主从复制单线程)>=5.5不会锁表，但是会主从复制(多线程)延迟2.影响正常数据(连接数猛增，插入连接被阻塞)
    - DDL：操作数据库、表、列等（这些对象进行操作），使用的关键字：CREATE、 ALTER、 DROP。
        - DML是对表中的数据进行增、删、改的操作。不要与DDL混淆了，使用的关键字：INSERT 、UPDATE、 DELETE。

2、大事务

- 风险：1.锁定太多的数据，造成大量的阻塞和锁超时2.回滚是所需时间比较长3.执行时间长，容易造成主从复制（主从复制会在所有事务执行完执行）(原子性, 一致性, 隔离性, 持久性)

3、网卡流量

1000Mb = 125MB

**解决方法**

1.1、分库分表

难点：

分表主键的选择

分表后跨分区数据的查询和统计

1.2大表的历史数据归档减少对前后端业务的影响

难点：

归档时间点的选择(订单的话可以归档1年前)

如何进行归档操作

2.1.避免一次处理太多数据

2.2移除不必要在事务中的select操作

3.1.减少从服务器的数量

3.2.进行分级缓存

3.3.避免使用select *

3.4.分离业务网络和服务器网络

- 事务(原子性,一致性，隔离性，持久性)
- sql标准定义的四种隔离级别未提交读 脏读(READ UNCOMMITED)已提交读（READ COMMITED）可重复读（REPEATABLE READ）读提交前不可以读到别的事务提交的数据，mysql默认可串行化(SERIALIZABLE)